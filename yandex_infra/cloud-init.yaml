#cloud-config
datasource:
  Ec2:
    strict_id: false
ssh_pwauth: no
users:
 - name: fill
   sudo: 'ALL=(ALL) NOPASSWD:ALL'
   shell: /bin/bash
   ssh_authorized_keys:
   - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIL+O6cXczlSLnL0wZSMe6qRNKpfbdiG6BtYwCmvi5ctR fill@Macmini.local
   - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOlPFhFwKepToM3D/5wgUfFsPsv99sZkfUr9gnuhYYr/ fill@MacBookAir.local
   - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDeQO0sjS7XJIZEYtbNIh07FQJymzGY3+XBaJEa7XEdK fill@test
   - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIN6DtL2KzXFUB43Z4LZrqLMc7YY2rlAUjtCl6EpycHBq Generated By Termius
packages:
  - nginx
  - certbot
  - python3-certbot-nginx

write_files:
  - path: /etc/nginx/sites-available/nexus.eqlan.online
    permissions: '0644'
    encoding: b64
    content: ${nginx_config}

      # Конфигурация для app.eqlan.online
  - path: /etc/nginx/sites-available/app.eqlan.online
    permissions: '0644'
    encoding: b64
    content: ${nginx_config_app}

  - path: /etc/acme/eqlan.ru_ecc/wildcard.crt
    permissions: '0644'
    encoding: b64
    content: ${ssl_certificate}

  - path: /etc/acme/eqlan.ru_ecc/wildcard.key
    permissions: '0600'
    encoding: b64
    content: ${ssl_key}

runcmd:
  # Создание директорий для сертификатов
  - mkdir -p /etc/acme/eqlan.ru_ecc

  # Удаление дефолтного сайта
  - rm -f /etc/nginx/sites-enabled/default

  # Включение конфигурации nexus
  - ln -sf /etc/nginx/sites-available/nexus.eqlan.online /etc/nginx/sites-enabled/
  - ln -sf /etc/nginx/sites-available/app.eqlan.online /etc/nginx/sites-enabled/

  # Проверка конфигурации Nginx
  - nginx -t

  # Перезапуск Nginx
  - systemctl restart nginx
  - systemctl enable nginx

final_message: "System setup completed after $UPTIME seconds"
